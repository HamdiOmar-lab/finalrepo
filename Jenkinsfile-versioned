pipeline {
    agent any

    environment {
        // VERSION = nom du tag Git dÃ©clencheur ; valeur par dÃ©faut si build manuel
        VERSION = "${GIT_TAG_NAME ?: 'manual-build'}"
    }

    stages {
        stage('Clean Workspace & Prune Git') {
            steps {
                echo "ğŸ§¹ Nettoyage du workspace et prune des branches Git obsolÃ¨tes..."
                deleteDir()
                bat 'git remote prune origin || echo No remote branches to prune'
            }
        }

        stage('Checkout') {
            steps {
                echo "ğŸ”„ Checkout du code pour la version ${VERSION}..."
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                echo "ğŸ“¦ Installation des dÃ©pendances..."
                bat 'npm install'
            }
        }

        stage('Build React App') {
            steps {
                echo "ğŸ—ï¸ Build de lâ€™application React pour la version ${VERSION}..."
                bat 'npm run build'
            }
        }

        stage('Clean Docker Container') {
            steps {
                echo "ğŸ§¹ Nettoyage ancien conteneur Docker..."
                bat 'docker rm -f react-app-container || echo No container to remove'
            }
        }

        stage('Run Docker') {
            steps {
                echo "ğŸš€ Lancement du conteneur Docker..."
                bat 'docker run -d -p 3000:80 --name react-app-container my-react-app'
            }
        }

        stage('Smoke Test') {
            steps {
                echo "ğŸ§ª Smoke test de la version ${VERSION}..."
                bat '''
                curl -s http://localhost:3000 -o response.html
                findstr /C:"<title>" response.html
                if %ERRORLEVEL% neq 0 exit 1
                echo Smoke test rÃ©ussi
                '''
            }
        }

        stage('Archive Versioned Artifacts') {
            steps {
                echo "ğŸ“ Archivage des artefacts pour la version ${VERSION}..."
                archiveArtifacts artifacts: 'build/**', fingerprint: true
                // Optionnel : renommer le dossier dâ€™archive selon la version
                bat "xcopy build build-${VERSION} /E /I /Y"
            }
        }
    }

    post {
        success {
            echo "âœ”ï¸ Pipeline complÃ©tÃ© avec succÃ¨s pour la version ${VERSION}"
        }
        failure {
            echo "âŒ Pipeline Ã©chouÃ© pour la version ${VERSION}"
        }
    }
}

