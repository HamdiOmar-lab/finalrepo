pipeline {
    agent any

    environment {
        VERSION = "${GIT_TAG_NAME}" // Variable qui rÃ©cupÃ¨re le tag dÃ©clencheur
    }

    stages {
        stage('Checkout') {
            steps {
                echo "ğŸ”„ Checkout du code..."
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                echo "ğŸ“¦ Installation des dÃ©pendances..."
                bat 'npm install'
            }
        }

        stage('Build React apk') {
            steps {
                echo "ğŸ—ï¸ Build de lâ€™application React pour version ${VERSION}..."
                bat 'npm run build'
            }
        }

        stage('Clean Docker Container') {
            steps {
                echo "ğŸ§¹ Nettoyage ancien conteneur Docker..."
                bat 'docker rm -f react-apk-container || echo "No container to remove"'
            }
        }

        stage('Run Docker') {
            steps {
                echo "ğŸš€ Lancement du conteneur Docker..."
                bat 'docker run -d -p 3000:80 --name react-apk-container my-react-apk'
            }
        }

        stage('Smoke Test') {
            steps {
                echo "ğŸ§ª Smoke test..."
                script {
                    bat '''
                    curl -s http://localhost:3000 -o response.html
                    findstr /C:"<title>" response.html
                    if %ERRORLEVEL% neq 0 exit 1
                    echo âœ… Smoke test rÃ©ussi
                    '''
                }
            }
        }

        stage('Archive Versioned Artifacts') {
            steps {
                echo "ğŸ“ Archivage des artefacts pour la version ${VERSION}..."
                archiveArtifacts artifacts: 'build/**', fingerprint: true, allowEmptyArchive: false
                // Optionnel : renommer le dossier dâ€™archive selon la version
                bat "xcopy build build-${VERSION} /E /I /Y"
            }
        }
    }

    post {
        success {
            echo "âœ”ï¸ Pipeline complÃ©tÃ© avec succÃ¨s pour la version ${VERSION}"
        }
        failure {
            echo "âŒ Pipeline Ã©chouÃ© pour la version ${VERSION}"
        }
    }
}
